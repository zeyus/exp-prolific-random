<!DOCTYPE html>
<html>
  <head>
    <title>Image ratings</title>
    <script src="js/jsPsych.js"></script>
    <script src="js/conf.js"></script>
    <script src="js/nouislider.min.js"></script>
    <script src="js/plugin-html-keyboard-response.js"></script>
    <script src="js/plugin-html-button-response.js"></script>
    <script src="js/plugin-call-function.js"></script>
    <script src="js/plugin-survey.browser.min.js"></script>
    <link rel="stylesheet" href="css/jspsych.css" />
    <link rel="stylesheet" href="css/survey.css">
    <link rel="stylesheet" href="css/plugin-survey.css">
    <link href="css/nouislider.min.css" rel="stylesheet" type="text/css" />
    <link href="css/prolific.css" rel="stylesheet" type="text/css" />
  </head>
  <body></body>
  <script>
    
    var jsPsych = initJsPsych({
      show_progress_bar: true,
      auto_update_progress_bar: false,
      on_finish: function() {
        // perhaps revisit this and handle with backend instead of jspsych
        window.location = prolificURL + prolificID;
      },
    });

    var save_response = function(data) {
      var xhr = new XMLHttpRequest();
      xhr.open('POST', 'lib/save_response.php');
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.send(JSON.stringify(data));
    }

    var slider_default = {
      class: "slider-response",
      tooltips: [{
        to: function (value) {
          return Math.round(value);
        },
        from: function (value) {
          return value;
        }
      }],
      range: {min: [0], max: [100]},
      pips: {
        mode: 'count',
        values: 5,
        density: 1
      },
      start: [50],
      step: 1
    };

    var slider_prefix = "slider_";

    var labels_abstract = {
      0: '0 (certain that it is abstract)',
      50: '50 (uncertain)',
      100: '100 (certain that it is concrete)'
    };
    var labels_abstract_values = {
      
    };
    labels_abstract_values[labels_abstract[0]] = 0,
    labels_abstract_values[labels_abstract[50]] = 50,
    labels_abstract_values[labels_abstract[100]] = 100

    var sliders = {
      ordered: [
        {
          name: slider_prefix + "creative",
          prompt: "How creative do you think this image is?"
        },
        {
          name: slider_prefix + "abstract",
          prompt: "How certain are you this image represents something concrete?",
          pips: {
            mode: 'count',
            values: 3,
            density: 1,
            format: {
              to: function (value) {
                var intval = Math.round(value);
                
                if (labels_abstract[intval]) {
                  return labels_abstract[intval];
                } else {
                  return intval;
                }
              },
              from: function (value) {
                if (labels_abstract_values[value]) {
                  return labels_abstract_values[value];
                } else {
                  return value;
                }
              }
            }
          }
        },
        {
          type: "html",
          name: slider_prefix + "symmetric",
          prompt: "How symmetrical is this image?"
        },
      ],
      named: {}
    };

    var form_sliders = [];

    for(i = 0; i < sliders.ordered.length; i++) {
      sliders.named[sliders.ordered[i].name] = {
        ...slider_default,
        ...sliders.ordered[i]
      };

      form_sliders[i] = {
        type: "html",
        prompt: '<span>' + sliders.ordered[i].prompt + '</span><div id="' + sliders.ordered[i].name + '" class="' + slider_default.class + '"></div>',
        name: sliders.ordered[i].name
      };

    }

    var createSlider = function(elId, wrapperEl, onChange) {
      var slider_class = sliders.named[elId].class;
      var slider_tooltips = sliders.named[elId].tooltips;
      var slider_range = sliders.named[elId].range;
      var slider_pips = sliders.named[elId].pips;
      var slider_start = sliders.named[elId].start;
      var slider_step = sliders.named[elId].step;
      elSelector = '#' + elId;

      var sliderRating = wrapperEl.querySelector(elSelector);

      noUiSlider.create(sliderRating, {
        start: slider_start,
        step: slider_step,
        range: slider_range,
        tooltips: slider_tooltips,
        pips: slider_pips
      });

      sliderRating.noUiSlider.on('update', function (values, handle) {
        var val = Math.round(values[handle]);
        // add the updated value to the trial's data
        jsPsych.getCurrentTrial().data[elId] = val;
        
      });
      sliderRating.noUiSlider.on('change', function (values, handle) {
        // call the onChange function to indicate slider has been interacted with.
        onChange(sliderRating);
      });
      return sliderRating;
    };

    // capture info from Prolific
    var subject_id = jsPsych.data.getURLVariable('PROLIFIC_PID');
    var study_id = jsPsych.data.getURLVariable('STUDY_ID');
    var session_id = jsPsych.data.getURLVariable('SESSION_ID');
    
    // Add Prolific info to data
    jsPsych.data.addProperties({
      subject_id: subject_id,
      study_id: study_id,
      session_id: session_id
    });

    /* create timeline */
    var timeline = [];


    var addImageTrials = async function(prompt_images) {
      if (prompt_images.length < 1) {
          const error_page = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: 'You have already rated all the images, thank you.',
            on_start: function() {
              jsPsych.setProgressBar(1);
            }
          }
          timeline.push(error_page);
          return;
        }
        var preambles = [];
        var n_images = prompt_images.length;
        for (var i = 0; i < n_images; i++) {
          preambles.push({
            pages: 
            [
              [
                {type: "html", prompt: '<img src="' + prompt_images[i]['image_uri'] + '" class="shape">'},
                ...form_sliders
              ]
            ],
            data: {
              prompt_id: prompt_images[i]['prompt_id'],
              user_prompt_id: prompt_images[i]['user_prompt_id'],
            },
          });
        }

        var slider_els = [];
        // to prevent the event handler from being called twice
        var surveyInitialized = false;
        var questionsInitialized = false;
        var completedButton;
        var completedButtonClass;

        var image_trials = {
          type: jsPsychSurvey,
          timeline: preambles,
          button_label_finish: "Continue",
          on_render_survey_complete: function(sender, options) {
            // initialize the survey
            if (!surveyInitialized) {
              completedButtonClass = sender.cssValue.navigation.complete;
              completedButton = sender.renderedElement.getElementsByClassName(completedButtonClass)[0];
              completedButton.disabled = true;
            }
          },
          on_render_question_complete: function(sender, options) {
            // only deal with sliders
            if (options.question.name.startsWith(slider_prefix)) {
              if (!questionsInitialized) {
                // add a onCompleting event handler to prevent survey from submitting
                // if any sliders have not yet been changed (or at least clicked).
                sender.onCompleting.add(function (sender, options) {
                  if(slider_els.length > 0) {
                    options.allowComplete = false;
                  }
                });
                questionsInitialized = true;
              }

              // create slider
              var slider = createSlider(options.question.name, options.htmlElement, function(curSlider) {
                // on change, remove it from the list of sliders
                for (var i = 0; i < slider_els.length; i++) {
                  if (slider_els[i] == curSlider) {
                    slider_els.splice(i, 1);
                    // deregister the slider's onChange event handler.
                    curSlider.noUiSlider.off('change');
                    break;
                  }
                }
                if (slider_els.length == 0) {
                  completedButton.disabled = false;
                }
              });
              // add the slider to the list of sliders
              slider_els.push(slider);
            }
          },
          on_finish: function(data) {
            var curr_progress_bar_value = jsPsych.getProgressBarCompleted();
            surveyInitialized = false;
            questionsInitialized = false;
            slider_els = [];
            jsPsych.setProgressBar(curr_progress_bar_value + (1/(n_images + 1)));
            save_response(data);
          }
          
        }
        const welcome_page = {
          type: jsPsychHtmlButtonResponse,
          stimulus: '<h2>Welcome to this study...</h2><div>In this survey you will be presented with '+ n_images +' images created by participants in a previous study.</div>' +
          '<div>This images will have the same number of blocks arranged in different ways, you can see some examples below.</div>' +
          '<img src="img/example.png" class="example">' +
          '<div>Each image will be accompanied by three questions...</div>',
          choices: ['Continue'],
          on_start: function() {
            jsPsych.setProgressBar(0);
          },
          on_finish: function(data) {
            var curr_progress_bar_value = jsPsych.getProgressBarCompleted();
            jsPsych.setProgressBar(curr_progress_bar_value + (1/(n_images + 1)));
          }
        }
        timeline.push(welcome_page);
        timeline.push(image_trials);
        
    };

    var init_survey = async function ()  {
      const options = {
            method: 'POST',
            body: JSON.stringify(jsPsych.data.dataProperties),
            headers: {
                'Content-Type': 'application/json'
            }
        }

        fetch('lib/get_survey_list.php', options)
        .then(res => res.json())
        .then(res => {
          res.length > 0 ? addImageTrials(res) : addImageTrials([]);
          addImageTrials(res).then(runTrials);
        }).catch(err => {
          addImageTrials([]).then(runTrials);
          console.log(err);
        });
    }
    
    runTrials = function () {
      var saveResults = {
      type: jsPsychCallFunction,
      async: true,
      func: function(done){
          var xhr = new XMLHttpRequest();
          xhr.open('POST', 'lib/save.php');
          xhr.setRequestHeader('Content-Type', 'application/json');
          xhr.onload = function() {
            done();
          };
          xhr.send(JSON.stringify({filedata: jsPsych.data.get().csv()}));
        }
      }
      timeline.push(saveResults);

      jsPsych.run(timeline);
    }

    init_survey();
    
  </script>
</html>