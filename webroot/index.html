<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Image ratings</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="js/jsPsych.js"></script>
    <script src="js/conf.js"></script>
    <script src="js/nouislider.min.js"></script>
    <script src="js/plugin-html-keyboard-response.js"></script>
    <script src="js/plugin-html-button-response.js"></script>
    <script src="js/plugin-call-function.js"></script>
    <script src="js/plugin-survey.browser.min.js"></script>
    <script src="js/Tooltip.js" type="text/javascript"></script>
    <link rel="stylesheet" href="css/jspsych.css" />
    <link rel="stylesheet" href="css/survey.css">
    <link rel="stylesheet" href="css/plugin-survey.css">
    <link href="css/nouislider.min.css" rel="stylesheet" type="text/css" />
    <link href="css/prolific.css" rel="stylesheet" type="text/css" />
  </head>
  <body>
  <script>
    
    var jsPsych = initJsPsych({
      show_progress_bar: true,
      auto_update_progress_bar: false,
      on_finish: function() {
        // perhaps revisit this and handle with backend instead of jspsych
        window.location = prolificURL + prolificID;
      },
    });

    var save_response = function(data) {
      var xhr = new XMLHttpRequest();
      xhr.open('POST', 'lib/save_response.php');
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.send(JSON.stringify(data));
    }

    var slider_default = {
      class: "slider-response",
      tooltips: [{
        to: function (value) {
          return Math.round(value);
        },
        from: function (value) {
          return value;
        }
      }],
      range: {min: [0], max: [100]},
      pips: {
        mode: 'count',
        values: 5,
        density: 1
      },
      start: [50],
      step: 1
    };

    var slider_prefix = "slider_";

    var labels_abstract = {
      0: '0 (certain that it is abstract)',
      50: '50 (uncertain)',
      100: '100 (certain that it is concrete)'
    };
    var labels_abstract_values = {
      
    };
    labels_abstract_values[labels_abstract[0]] = 0,
    labels_abstract_values[labels_abstract[50]] = 50,
    labels_abstract_values[labels_abstract[100]] = 100

    var sliders = {
      ordered: [
        {
          name: slider_prefix + "creative",
          prompt: "How creative do you think this image is?",
          help: "You can rate the creativity on a scale from 0 (not creative) to 100 (very creative)."
        },
        {
          name: slider_prefix + "abstract",
          prompt: "How certain are you this image represents something concrete?",
          help: "If this represents a concrete object, you can rate the certainty on a scale from 0 (certain that it is concrete) to 100 (certain that it is abstract).",
          pips: {
            mode: 'count',
            values: 3,
            density: 1,
            format: {
              to: function (value) {
                var intval = Math.round(value);
                
                if (labels_abstract[intval]) {
                  return labels_abstract[intval];
                } else {
                  return intval;
                }
              },
              from: function (value) {
                if (labels_abstract_values[value]) {
                  return labels_abstract_values[value];
                } else {
                  return value;
                }
              }
            }
          }
        },
        {
          type: "html",
          name: slider_prefix + "symmetric",
          prompt: "How symmetrical is this image?",
          help: "You can rate the symmetry on a scale from 0 (not symmetrical) to 100 (very symmetrical)."
        },
      ],
      named: {}
    };

    var form_sliders = [];

    for(i = 0; i < sliders.ordered.length; i++) {
      sliders.named[sliders.ordered[i].name] = {
        ...slider_default,
        ...sliders.ordered[i]
      };

      form_sliders[i] = {
        type: "html",
        prompt: '<span>' + sliders.ordered[i].prompt + '</span> <span class="rating-help" data-tooltip="{ ' + "'offset': 10, 'class': 'alt-tooltip'" + ' }" title="' + sliders.ordered[i].help + '">?</span><div id="' + sliders.ordered[i].name + '" class="' + slider_default.class + '"></div>',
        name: sliders.ordered[i].name
      };

    }

    var createSlider = function(elId, wrapperEl, onChange) {
      var slider_class = sliders.named[elId].class;
      var slider_tooltips = sliders.named[elId].tooltips;
      var slider_range = sliders.named[elId].range;
      var slider_pips = sliders.named[elId].pips;
      var slider_start = sliders.named[elId].start;
      var slider_step = sliders.named[elId].step;
      elSelector = '#' + elId;

      var sliderRating = wrapperEl.querySelector(elSelector);

      noUiSlider.create(sliderRating, {
        start: slider_start,
        step: slider_step,
        range: slider_range,
        tooltips: slider_tooltips,
        pips: slider_pips
      });

      sliderRating.noUiSlider.on('update', function (values, handle) {
        var val = Math.round(values[handle]);
        // add the updated value to the trial's data
        jsPsych.getCurrentTrial().data[elId] = val;
        
      });
      sliderRating.noUiSlider.on('change', function (values, handle) {
        // call the onChange function to indicate slider has been interacted with.
        onChange(sliderRating);
      });
      return sliderRating;
    };

    // capture info from Prolific
    var subject_id = jsPsych.data.getURLVariable('PROLIFIC_PID');
    var study_id = jsPsych.data.getURLVariable('STUDY_ID');
    var session_id = jsPsych.data.getURLVariable('SESSION_ID');
    
    // Add Prolific info to data
    jsPsych.data.addProperties({
      subject_id: subject_id,
      study_id: study_id,
      session_id: session_id
    });

    /* create timeline */
    var timeline = [];


    var addImageTrials = async function(prompt_images) {
      if (prompt_images.length < 1) {
          const error_page = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: 'You have already rated all the images, thank you.',
            on_start: function() {
              jsPsych.setProgressBar(1);
            }
          }
          timeline.push(error_page);
          return;
        }
        var preambles = [];
        var n_images = prompt_images.length;
        for (var i = 0; i < n_images; i++) {
          preambles.push({
            pages: 
            [
              [
                {type: "html", prompt: '<img src="' + prompt_images[i]['image_uri'] + '" class="shape">'},
                ...form_sliders
              ]
            ],
            data: {
              prompt_id: prompt_images[i]['prompt_id'],
              user_prompt_id: prompt_images[i]['user_prompt_id'],
            },
          });
        }

        var slider_els = [];
        // to prevent the event handler from being called twice
        var surveyInitialized = false;
        var questionsInitialized = false;
        var completedButton;
        var completedButtonClass;

        var image_trials = {
          type: jsPsychSurvey,
          timeline: preambles,
          button_label_finish: "Continue",
          on_render_survey_complete: function(sender, options) {
            // initialize the survey
            if (!surveyInitialized) {
              completedButtonClass = sender.cssValue.navigation.complete;
              completedButton = sender.renderedElement.getElementsByClassName(completedButtonClass)[0];
              completedButton.disabled = true;
            }
          },
          on_render_question_complete: function(sender, options) {
            // only deal with sliders
            if (options.question.name.startsWith(slider_prefix)) {
              if (!questionsInitialized) {
                // add a onCompleting event handler to prevent survey from submitting
                // if any sliders have not yet been changed (or at least clicked).
                sender.onCompleting.add(function (sender, options) {
                  if(slider_els.length > 0) {
                    options.allowComplete = false;
                  }
                });
                questionsInitialized = true;
              }

              // create slider
              var slider = createSlider(options.question.name, options.htmlElement, function(curSlider) {
                // on change, remove it from the list of sliders
                for (var i = 0; i < slider_els.length; i++) {
                  if (slider_els[i] == curSlider) {
                    slider_els.splice(i, 1);
                    // deregister the slider's onChange event handler.
                    curSlider.noUiSlider.off('change');
                    break;
                  }
                }
                if (slider_els.length == 0) {
                  completedButton.disabled = false;
                }
              });
              // add the slider to the list of sliders
              slider_els.push(slider);
            }
          },
          on_finish: function(data) {
            var curr_progress_bar_value = jsPsych.getProgressBarCompleted();
            surveyInitialized = false;
            questionsInitialized = false;
            slider_els = [];
            jsPsych.setProgressBar(curr_progress_bar_value + (1/(n_images + 1)));
            save_response(data);
          }
          
        }
        const consent_page = {
          type: jsPsychHtmlButtonResponse,
          stimulus: consent_text,
          choices: ['Next'],
          on_start: function() {
            jsPsych.setProgressBar(0);
          }
        }
        const welcome_page = {
          type: jsPsychHtmlButtonResponse,
          stimulus: '<div style="text-align: left;"><h2>Task instructions</h2><div>In the following, you will be presented with '+ n_images +' simple figures one-by-one. All figures consist of 10 small green squares on black background (see some examples of figures below).</div>' +
          '<img src="img/example.png" class="example">' +
          '<div>Your task is, for each figure, to rate them for three different properties. Please read through the explanation of the three rating scales very carefully until you feel you have a good understanding of what you are supposed to do.</div>' +
          '<ol class="custom-list-marker custom-list-numeric-par">' +
          '<li>First, you will rate <b>how creative you find the figure</b> on a scale from 1 to 100, where 1 is <u>not creative</u> and 100 is <u>very creative</u>. Remember that all figures are produced from the same 10 green tiles and have to stay connected in one shape. The relative creativity of a figure should be assessed from this constraint. A creative figure could be one that you find <b>surprising and interesting</b> relative to other figures.</li>' +
          '<li>Next, you will rate their concreteness/abstractness, that is <b>how likely you find the figure to be intended to resemble something</b>. Some figures might be made purposefully to look like something particular, for instance an animal, an airplane, or a letter. Others might be abstract shapes that are not intended to look like something particular, but are interesting on their own, for instance a strange geometrical shape. The scale reflects how certain you are if the figure is one or the other. The middle value 50 indicates that you are <u>very uncertain</u>. 1 indicates that you are <u>certain that the shape is abstract</u> and does not resemble anything particular. 100 indicates that you are <u>certain that the figure resembles something concrete</u> that you could potentially name (like e.g. an object, animal or letter).</li>' +
          '<li>Last, you will rate <b>how symmetric you find the figure</b> on a scale from 1 to 100, where 1 indicates that the figure is not symmetric at all, and 100 means that it is perfectly symmetric. Notice, that symmetry can be relative to one or more symmetry lines. A figure can be the perfect mirror of itself either horizontally, vertically or diagonally. It can also have more than one symmetry line. You can also have figures that show imperfect symmetry (close to be symmetric) or that have no symmetry at all.</li>' +
          '</ol>' +
          '<div>The rating is self-paced. That is, you can just all the time you want to inspect the figure before you make a rating on each of the three scales (creativity, concreteness and symmetry). If you would like to return to the explanations of the rating scales later during the task, you can hover over the <span class="rating-help">?</span> symbol next to each of the rating scales. </div>' +
          '</div>',
          choices: ['Next'],
          on_start: function() {
            jsPsych.setProgressBar(0);
          },
          on_finish: function(data) {
            var curr_progress_bar_value = jsPsych.getProgressBarCompleted();
            jsPsych.setProgressBar(curr_progress_bar_value + (1/(n_images + 1)));
          }
        }
        timeline.push(consent_page);
        timeline.push(welcome_page);
        timeline.push(image_trials);
        
    };

    var init_survey = async function ()  {
      const options = {
            method: 'POST',
            body: JSON.stringify(jsPsych.data.dataProperties),
            headers: {
                'Content-Type': 'application/json'
            }
        }

        fetch('lib/get_survey_list.php', options)
        .then(res => res.json())
        .then(res => {
          res.length > 0 ? addImageTrials(res) : addImageTrials([]);
          addImageTrials(res).then(runTrials);
        }).catch(err => {
          addImageTrials([]).then(runTrials);
          console.log(err);
        });
    }
    
    runTrials = function () {
      var saveResults = {
      type: jsPsychCallFunction,
      async: true,
      func: function(done){
          var xhr = new XMLHttpRequest();
          xhr.open('POST', 'lib/save.php');
          xhr.setRequestHeader('Content-Type', 'application/json');
          xhr.onload = function() {
            done();
          };
          xhr.send(JSON.stringify({filedata: jsPsych.data.get().csv()}));
        }
      }
      timeline.push(saveResults);

      jsPsych.run(timeline);
    }

    init_survey();
    
  </script>
</html>